<!DOCTYPE html>
<html>
<head>
    <title>ModelZoo</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
        }
        .left-column, .right-column {
            flex: 1;
            padding: 10px;
        }
        .model-list, .running-list, #launch-dialog {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-ready {
            background-color: green;
        }
        .status-starting {
            background-color: yellow;
        }
        .logs {
            font-family: monospace;
            background: #f0f0f0;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            cursor: pointer;
        }
        #launch-dialog {
            display: none;
        }
        .zoo-list {
            margin-bottom: 10px;
        }
        h2 {
            margin: 5px;
        }
        #show-more-container {
            text-align: center;
            margin-top: 10px;
        }
        #show-more-btn {
            background-color: #f2f2f2;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .chevron {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="left-column">
        <div class="model-list">
            <h2>Available Models</h2>

            {% for name, zoo in zoos.items() %}
            <div class="zoo-list">
                <input type="checkbox" class="zoo-toggle" data-zoo="{{ name }}" 
                       {% if zoo_enabled[name] %}checked{% endif %}>
                {{ name }} - {{ zoo }}
            </div>
            {% endfor %}

            <table id="model-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Format</th>
                        <th>Size</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for model in available_models[:10] %}
                    <tr class="model-row">
                        <td>{{ model.model_name }}</td>
                        <td>{{ model.model_format }}</td>
                        <td>{{ human_size(model.model_size) }}</td>
                        <td>
                            <button onclick="showLaunchDialog('{{ model.model_id }}', '{{ model.model_name }}')">Launch</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if available_models|length > 10 %}
            <div id="show-more-container">
                <button id="show-more-btn" onclick="toggleShowMore()">
                    Show More <span class="chevron">▼</span>
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="right-column">
        <div id="launch-dialog">
            <h2>Launch Model: <span id="launch-model-name"></span></h2>
            <select id="runtime-select" onchange="loadRuntimeParams()">
                {% for name, runtime in runtimes.items() %}
                <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
            </select>
            
            <select id="env-select">
                {% for name, env in environments.items() %}
                <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
            </select>

            <div id="runtime-params">
            </div>

            <div>
                <input type="number" id="port-input" value="{{ random_port }}">
                <span>Listen Port</span>
            </div>

            <button onclick="launchModel()">Launch</button>
            <button onclick="$('#launch-dialog').hide()">Cancel</button>
        </div>

        <div class="running-list">
            <h2>Running Models</h2>
            {% for running in running_models %}
            <div class="running-model">
                <h3>
                    <span class="status-indicator {{ 'status-ready' if running.ready() else 'status-starting' }}"></span>
                    {{ running.model.model_name }}
                </h3>
                <p>{{ running.listener }} ({{ running.runtime.runtime_name }})</p>
                <button onclick="toggleLogs({{ loop.index0 }})">Show/Hide Logs</button>
                <button onclick="stopModel({{ loop.index0 }})">Stop</button>
                <div class="logs" id="logs-{{ loop.index0 }}" style="display: none;"></div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        const runtimes = {{ runtimes | tojson | safe }};
        const allModels = {{ available_models | tojson | safe }};

        function toggleShowMore() {
            const table = document.getElementById('model-table');
            const btn = document.getElementById('show-more-btn');
            const chevron = btn.querySelector('.chevron');
            const tbody = table.querySelector('tbody');

            if (btn.textContent.includes('Show More')) {
                // Show all models
                tbody.innerHTML = '';
                allModels.forEach(model => {
                    tbody.innerHTML += `
                        <tr class="model-row">
                            <td>${model.model_name}</td>
                            <td>${model.model_format}</td>
                            <td>${humanSize(model.model_size)}</td>
                            <td>
                                <button onclick="showLaunchDialog('${model.model_id}', '${model.model_name}')">Launch</button>
                            </td>
                        </tr>
                    `;
                });
                btn.innerHTML = 'Show Less <span class="chevron">▲</span>';
            } else {
                // Show only first 10 models
                tbody.innerHTML = '';
                allModels.slice(0, 10).forEach(model => {
                    tbody.innerHTML += `
                        <tr class="model-row">
                            <td>${model.model_name}</td>
                            <td>${model.model_format}</td>
                            <td>${humanSize(model.model_size)}</td>
                            <td>
                                <button onclick="showLaunchDialog('${model.model_id}', '${model.model_name}')">Launch</button>
                            </td>
                        </tr>
                    `;
                });
                btn.innerHTML = 'Show More <span class="chevron">▼</span>';
            }
        }

        function humanSize(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 Byte';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }

        // Zoo toggle handling
        $('.zoo-toggle').change(function() {
            const zoo = $(this).data('zoo');
            $.post(`/api/zoo/${zoo}/toggle`, function() {
                location.reload();
            });
        });

        // Launch dialog
        function showLaunchDialog(modelId, modelName) {
            $('#launch-dialog').show();
            $('#launch-dialog').data('modelId', modelId);
            $('#launch-model-name').text(modelName);
            
            // Load runtime parameters
            loadRuntimeParams();
        }

        function loadRuntimeParams() {
            const runtime = $('#runtime-select').val();
            const params = runtimes[runtime].runtime_params;
            const container = $('#runtime-params').empty();
            
            params.forEach(param => {
                let input;
                if (param.param_type === 'bool') {
                    input = `<input type="checkbox" 
                                    name="${param.param_name}" 
                                    ${param.param_default ? 'checked' : ''}>`;
                } else if (param.param_type === 'int') {
                    input = `<input type="number" 
                                    name="${param.param_name}" 
                                    value="${param.param_default}">`;
                } else {
                    input = `<input type="text" 
                                    name="${param.param_name}" 
                                    value="${param.param_default}">`;
                }
                
                container.append(`
                    <div>
                        ${input}
                        <span>${param.param_description}</span>
                    </div>
                `);
            });
        }

        function launchModel() {
            const modelId = $('#launch-dialog').data('modelId');
            const runtime = $('#runtime-select').val();
            const env = $('#env-select').val();
            const port = $('#port-input').val();
            
            const params = {};
            $('#runtime-params input').each(function() {
                const $input = $(this);
                const name = $input.attr('name');
                const type = runtimes[runtime].runtime_params.find(p => p.param_name === name).param_type;
                
                if (type === 'bool') {
                    params[name] = $input.is(':checked');
                } else if (type === 'int') {
                    params[name] = parseInt($input.val(), 10);
                } else {
                    params[name] = $input.val();
                }
            });

            $.post('/api/model/launch', {
                model_id: modelId,
                runtime: runtime,
                environment: env,
                port: parseInt(port, 10),
                params: JSON.stringify(params)
            }, function() {
                $('#launch-dialog').hide();
                location.reload();
            });
        }

        // Running model handling
        function toggleLogs(idx) {
            const logsDiv = $(`#logs-${idx}`);
            if (logsDiv.is(':visible')) {
                logsDiv.hide();
                if (window.logPollers && window.logPollers[idx]) {
                    clearInterval(window.logPollers[idx]);
                }
            } else {
                logsDiv.show();
                pollLogs(idx);
            }
        }

        function pollLogs(idx) {
            if (!window.logPollers) window.logPollers = {};
            
            function updateStatusAndLogs() {
                $.get(`/api/model/${idx}/logs`, function(logs) {
                    $(`#logs-${idx}`).html(logs.reverse().join('<br>'));
                });

                $.get(`/api/model/${idx}/status`, function(status) {
                    const statusIndicator = $(`#logs-${idx}`).closest('.running-model').find('.status-indicator');
                    if (status.ready) {
                        statusIndicator.removeClass('status-starting').addClass('status-ready');
                    } else {
                        statusIndicator.removeClass('status-ready').addClass('status-starting');
                    }
                });
            }
            
            updateStatusAndLogs();
            window.logPollers[idx] = setInterval(updateStatusAndLogs, 2000);
        }

        function stopModel(idx) {
            $.post(`/api/model/${idx}/stop`, function() {
                location.reload();
            });
        }
    </script>
</body>
</html>
